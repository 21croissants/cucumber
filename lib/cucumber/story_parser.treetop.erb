grammar Story
  rule story
    header narrative scenario_nodes:scenario* {
      def eval(story_handler)
        header.eval(story_handler)
        narrative.eval(story_handler)
        scenario_nodes.elements.each do |scenario_node|
          scenario_node.eval(story_handler)
        end
      end
    }
  end

  rule header
    '<%= words['story'] %>:' space sentence_line {
      def eval(story_handler)
        story_handler.story(sentence_line.text_value)
      end
    }
  end

  rule narrative
    (!scenario_start .)* {
      def eval(story_handler)
        story_handler.narrative(self.text_value)
      end
    }
  end

  rule scenario
    scenario_start sentence:sentence_line step_nodes:(step)* {
      def eval(story_handler)
        story_handler.scenario(sentence.text_value)
        step_nodes.elements.each do |step_node|
          step_node.eval(story_handler)
        end
      end
    }
  end
  
  rule scenario_start
    space '<%= words['scenario'] %>: '
  end

  rule step
    space step_type:('<%= words['given'] %>' / '<%= words['when'] %>' / '<%= words['then'] %>' / '<%= words['given_scenario'] %>') space sentence:sentence_line {
      def eval(story_handler)
        story_handler.step(step_type.text_value, sentence.text_value, input.line_of(interval.first))
      end
    }
  end

  rule sentence_line
    (!eol .)* eol
  end

  rule space
    [ \n]*
  end

  rule eol
    "\n" / eof
  end
  
  rule eof
    !.
  end
end

grammar Story
  rule story
    header narrative scenario_nodes:scenario* {
      attr_accessor :file

      def accept(visitor)
        visitor.visit_header(header)
        visitor.visit_narrative(narrative)
        scenario_nodes.elements.each do |scenario_node|
          visitor.visit_scenario(scenario_node)
        end
      end
    }
  end

  rule header
    '<%= words['story'] %>:' space sentence_line {
      def name
        sentence_line.text_value.strip
      end
    }
  end

  rule narrative
    (!scenario_start .)* {
      # text_value to get the string
    }
  end

  rule scenario
    scenario_start sentence:sentence_line step_nodes:(step)* {
      def accept(visitor)
        step_nodes.elements.each do |step_node|
          visitor.visit_step(step_node)
        end
      end

      def name
        sentence.text_value.strip
      end

      def file
        parent.parent.file
      end
    }
  end
  
  rule scenario_start
    space '<%= words['scenario'] %>: '
  end

  rule step
    space step_type:('<%= words['given'] %>' / '<%= words['when'] %>' / '<%= words['then'] %>'/ '<%= words['and'] %>' / '<%= words['given_scenario'] %>') space sentence:sentence_line {
      attr_accessor :error

      def line
        input.line_of(interval.first)
      end

      def name
        sentence.text_value.strip
      end

      def keyword
        step_type.text_value.strip
      end

      def file
        parent.parent.file
      end
    }
  end

  rule sentence_line
    (!eol .)* eol
  end

  rule space
    [ \n]*
  end

  rule eol
    "\n" / eof
  end
  
  rule eof
    !.
  end
end
